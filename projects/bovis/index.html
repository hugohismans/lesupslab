<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DÃ©tecteur "Ã©nergies" â€“ lecture style Bovis (expÃ©rimental)</title>
  <style>
    :root {
      --bg: #0b0e13;
      --card: #131a22;
      --ink: #e8f0ff;
      --muted: #92a2c0;
      --accent: #86e1ff;
      --good: #5ce08e;
      --warn: #ffd36e;
      --bad: #ff7a7a;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 700px at 80% -10%,#1b2735,transparent),
                      radial-gradient(900px 600px at -10% 110%,#141a24,transparent),
                      var(--bg);
         color:var(--ink);font:16px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial,Apple Color Emoji,Noto Color Emoji,EmojiOne}
    .wrap{max-width:1050px;margin:24px auto;padding:16px}
    .grid{display:grid;gap:16px;grid-template-columns:1.1fr 1fr}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));
          border:1px solid rgba(255,255,255,.08);border-radius:18px;padding:18px;box-shadow:var(--shadow)}
    h1{font-size:clamp(22px,2.6vw,32px);margin:0 0 8px 0;letter-spacing:.3px}
    p.small{color:var(--muted);margin:.3rem 0}
    label{display:block;color:var(--muted);font-size:13px;margin:6px 0 6px 2px}
    input[type="number"],input[type="text"],select{width:100%;
      background:#0f141b;color:var(--ink);border:1px solid rgba(255,255,255,.12);
      border-radius:12px;padding:12px 14px;outline:none}
    input[type="number"]:focus,input[type="text"]:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(134,225,255,.18)}
    button{background:linear-gradient(180deg,#2a3a4e,#1c2836);color:var(--ink);
      border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:11px 14px;cursor:pointer}
    button:hover{filter:brightness(1.06)}
    .row{display:flex;gap:10px;align-items:center}
    .row>div{flex:1}
    .muted{color:var(--muted)}
    .pill{display:inline-block;border-radius:999px;padding:6px 10px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);font-size:12px}
    .gauge{position:relative;height:260px}
    .gauge svg{display:block;width:100%;height:100%}
    .needle{transform-origin:50% 85%;transition:transform .8s cubic-bezier(.2,.9,.2,1.1)}
    .value{font-size:38px;font-weight:700;letter-spacing:.5px}
    .unit{font-size:13px;color:var(--muted)}
    .status{font-weight:600}
    .list{display:grid;gap:10px}
    .advice{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));
            border:1px dashed rgba(255,255,255,.12);padding:10px 12px;border-radius:12px}
    .footer{margin-top:10px;font-size:12px;color:var(--muted)}
    .switch{display:inline-flex;gap:8px;align-items:center}
    .switch input{accent-color:#86e1ff}
    .tag{font-size:12px;padding:4px 8px;border-radius:10px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12)}
    .ok{color:var(--good)} .warn{color:var(--warn)} .bad{color:var(--bad)}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .spark{height:46px}
    .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;background:#0f141b;border:1px solid rgba(255,255,255,.1);padding:2px 6px;border-radius:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>DÃ©tecteur dâ€™Â«Â Ã©nergiesÂ Â» â€“ Lectures style <span class="pill">Bovis (expÃ©rimental)</span></h1>
    <p class="small">NoteÂ : cet outil est ludique et mÃ©ditatif. Les Â«Â unitÃ©s BovisÂ Â» nâ€™ont pas de base scientifique reconnue. Aucune lecture ne doit Ãªtre interprÃ©tÃ©e comme un avis mÃ©dical ou de sÃ©curitÃ©.</p>

    <div class="grid">
      <section class="card">
        <div class="row" style="flex-wrap:wrap;gap:12px">
          <div style="min-width:200px;flex:2">
            <label>Nom du lieu (optionnel)</label>
            <input id="placeName" type="text" placeholder="Maison, Cabinet, Parcâ€¦"/>
          </div>
          <div>
            <label>Latitude</label>
            <input id="lat" type="number" step="0.000001" placeholder="50.45"/>
          </div>
          <div>
            <label>Longitude</label>
            <input id="lon" type="number" step="0.000001" placeholder="3.93"/>
          </div>
        </div>
        <div class="row" style="margin-top:8px;flex-wrap:wrap;gap:10px">
          <button id="btnLocate">Utiliser ma position</button>
          <button id="btnStart">DÃ©marrer</button>
          <button id="btnStop" disabled>Pause</button>
          <button id="btnExport" title="Export CSV des lectures">Exporter CSV</button>
          <span class="pill" id="sessionState">â¸ï¸ En pause</span>
          <span class="pill" id="wakelockState" title="EmpÃªche la mise en veille si possible">ğŸ”’ Ã‰cran actifÂ : non</span>
        </div>
        <div class="row" style="margin-top:10px;gap:12px;align-items:flex-end">
          <div>
            <label>Rayon dâ€™observation (m)</label>
            <input id="radius" type="number" min="1" step="1" value="20" />
          </div>
          <div>
            <label>RÃ©glage de base (kBv)</label>
            <input id="baseline" type="number" min="0" step="100" value="9000" />
          </div>
          <div>
            <label>SensibilitÃ©</label>
            <select id="sensitivity">
              <option value="low">Faible</option>
              <option value="med" selected>Moyenne</option>
              <option value="high">Haute</option>
            </select>
          </div>
          <div class="switch">
            <input id="soundToggle" type="checkbox" />
            <label for="soundToggle">Carillon sur variation forte</label>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="gauge">
          <!-- Demi-jauge en SVG -->
          <svg viewBox="0 0 100 60" preserveAspectRatio="xMidYMid meet">
            <defs>
              <linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" stop-color="#ff7a7a"/>
                <stop offset="45%" stop-color="#ffd36e"/>
                <stop offset="70%" stop-color="#86e1ff"/>
                <stop offset="100%" stop-color="#5ce08e"/>
              </linearGradient>
            </defs>
            <path d="M10,55 A40,40 0 0 1 90,55" fill="none" stroke="url(#grad)" stroke-width="6"/>
            <!-- ticks -->
            <g id="ticks"></g>
            <!-- aiguille -->
            <g class="needle" id="needle">
              <polygon points="49.4,55 50.6,55 50,15" fill="#e8f0ff"/>
              <circle cx="50" cy="55" r="2.3" fill="#e8f0ff"/>
            </g>
          </svg>
        </div>
        <div class="row" style="justify-content:space-between">
          <div>
            <div class="value"><span id="reading">â€”</span> <span class="unit">kBv</span></div>
            <div class="muted">Plage dynamique adaptativeÂ : <span id="range">6Â 000 â†’ 18Â 000 kBv</span></div>
          </div>
          <div class="tag" id="status">â€”</div>
        </div>
        <canvas class="spark" id="spark" width="600" height="46"></canvas>
      </section>
    </div>

    <section class="card" style="margin-top:16px">
      <h3 style="margin:.3rem 0 10px 0">Conseils dâ€™harmonisation (automatiques)</h3>
      <div class="grid-2 list" id="adviceList"></div>
      <div class="footer">AstuceÂ : laissez lâ€™onglet ouvert. Les lectures se mettront Ã  jour toutes les quelques secondes et seront consignÃ©es. <span class="kbd">S</span> pour dÃ©marrer/pauser rapidement.</div>
    </section>

    <section class="card" style="margin-top:16px">
      <h3 style="margin:.3rem 0 10px 0">Journal de session</h3>
      <div id="log" class="list" style="max-height:220px;overflow:auto"></div>
    </section>

    <p class="small" style="margin-top:14px">TransparenceÂ : la Â«Â mesureÂ Â» utilise un bruit pseudoâ€‘alÃ©atoire lissÃ© basÃ© sur lâ€™instant, la position GPS, le rayon et des microâ€‘mouvements dâ€™appareil si disponibles (orientation). Câ€™est un indicateur symbolique pour soutenir lâ€™intention, la prÃ©sence et vos pratiques Ã©nergÃ©tiques, pas un instrument scientifique.</p>
  </div>

  <script>
    // ====== Utilitaires ======
    const $ = sel => document.querySelector(sel);
    const clamp = (v,min,max)=>Math.min(max,Math.max(min,v));
    const lerp = (a,b,t)=>a+(b-a)*t;
    const map = (v,a,b,c,d)=> c + (d-c)*((v-a)/(b-a));

    // Petite fonction de bruit lisse (sans dÃ©pendances)
    // Combinaison de sinusoÃ¯des et d'un LCG seedÃ© par lat/lon
    function seededRand(seed){
      let s = Math.imul(seed>>>0, 2654435761) >>> 0;
      return ()=> (s = (s + 0x6D2B79F5) >>> 0, (s ^ (s>>>15)) / 0xFFFFFFFF);
    }
    function smoothNoise(t, seedA, seedB){
      // t en secondes
      const rA = seededRand(seedA)();
      const rB = seededRand(seedB)();
      const w1 = Math.sin(t*0.15 + rA*6.2831);
      const w2 = Math.sin(t*0.031 + rB*6.2831);
      const w3 = Math.sin(t*0.007 + (rA+rB)*6.2831);
      return (w1*0.62 + w2*0.28 + w3*0.10 + 1)/2; // 0..1
    }

    // Ticks visuels de la jauge
    (function buildTicks(){
      const g = document.getElementById('ticks');
      for(let i=0;i<=10;i++){
        const x = 10 + (80*(i/10));
        const y1 = 55, y2 = 51.5;
        const line = document.createElementNS('http://www.w3.org/2000/svg','line');
        line.setAttribute('x1',x); line.setAttribute('y1',y1);
        line.setAttribute('x2',x); line.setAttribute('y2',y2);
        line.setAttribute('stroke','rgba(255,255,255,.6)');
        line.setAttribute('stroke-width', i%5===0? 1.7: 1);
        g.appendChild(line);
      }
    })();

    // ====== Ã‰tat ======
    let running = false;
    let lastVal = 9000;
    let history = []; // {t, val}
    let wakelock = null;

    // ====== DOM ======
    const elLat = $('#lat');
    const elLon = $('#lon');
    const elName = $('#placeName');
    const elRadius = $('#radius');
    const elBaseline = $('#baseline');
    const elSens = $('#sensitivity');
    const elReading = $('#reading');
    const elRange = $('#range');
    const elStatus = $('#status');
    const elNeedle = $('#needle');
    const elSpark = $('#spark');
    const elLog = $('#log');
    const elWakelock = $('#wakelockState');
    const elSession = $('#sessionState');

    // Restaurer derniers paramÃ¨tres
    (function restore(){
      try{
        const cfg = JSON.parse(localStorage.getItem('bovisCfg')||'{}');
        if(cfg.lat) elLat.value = cfg.lat;
        if(cfg.lon) elLon.value = cfg.lon;
        if(cfg.name) elName.value = cfg.name;
        if(cfg.radius) elRadius.value = cfg.radius;
        if(cfg.baseline) elBaseline.value = cfg.baseline;
        if(cfg.sens) elSens.value = cfg.sens;
      }catch(e){}
    })();

    function persist(){
      const cfg = { lat: +elLat.value||null, lon: +elLon.value||null, name: elName.value||'',
                    radius: +elRadius.value||20, baseline: +elBaseline.value||9000, sens: elSens.value };
      localStorage.setItem('bovisCfg', JSON.stringify(cfg));
    }

    // ====== Lecture principale ======
    function computeBovis(now){
      const lat = +elLat.value || 0;
      const lon = +elLon.value || 0;
      const radius = +elRadius.value || 1;
      const baseline = +elBaseline.value || 9000;
      const sens = elSens.value;

      // graines en fonction position/rayon
      const seedA = Math.abs(Math.floor((lat*1000) ^ (radius*17)));
      const seedB = Math.abs(Math.floor((lon*1000) ^ (radius*31)));
      const t = now/1000;
      let n = smoothNoise(t, seedA, seedB); // 0..1

      // modulations lentes par heure/jour
      const d = new Date(now);
      const hour = d.getUTCHours();
      const day = Math.floor(now / 86400000);
      const daily = Math.sin((day%29)/29 * Math.PI*2)*0.15 + 0.5; // pseudo cycle 
      const circ = Math.cos((hour/24)*Math.PI*2)*0.1 + 0.5;
      n = (n*0.72 + daily*0.18 + circ*0.10); // mÃ©lange

      // sensibilitÃ© = amplitude
      const amp = sens==='high' ? 5200 : sens==='low' ? 1800 : 3200;

      // bruit orientÃ© autour du baseline
      let value = baseline + (n-0.5)*2*amp; // baseline Â± amp

      // Lissage (inertie) pour Ã©viter les sauts trop brusques
      value = lerp(lastVal, value, 0.25);
      lastVal = value;

      // Contrainte plage visible adaptative (affichage uniquement)
      return clamp(Math.round(value), 1000, 200000);
    }

    function statusFor(v){
      if(v < 6000) return {label:'TrÃ¨s bas', cls:'bad'};
      if(v < 9000) return {label:'Bas', cls:'warn'};
      if(v < 11000) return {label:'Moyen', cls:''};
      if(v < 14000) return {label:'Harmonieux', cls:'ok'};
      if(v < 18000) return {label:'Ã‰levÃ©', cls:'ok'};
      return {label:'TrÃ¨s Ã©levÃ©', cls:'ok'};
    }

    function advicesFor(v){
      const base = [
        'AÃ©rez 3â€“5Â min et laissez entrer la lumiÃ¨re.',
        'Coupez les appareils inutilisÃ©s (bruit Ã©lectromagnÃ©tique).',
        'Rangez une petite zone (1 mÂ²) pour clarifier lâ€™espace.',
        'Buvez un grand verre dâ€™eau.',
        'Ajoutez une plante ou des fleurs au centre du lieu.',
        'Posez une intention claire pendant 60Â secondes (mains sur le cÅ“ur).',
        'Faites 5 cycles de respiration cohÃ©rente (5Â s inspire / 5Â s expire).'
      ];
      const low = [
        'Placez un bol de sel prÃ¨s de lâ€™entrÃ©e pendant 24Â h.',
        'Marchez 3Â minutes pieds bien ancrÃ©s en conscience (si extÃ©rieur possible).',
        'Diffusez une musique douce ou sons de nature ~10Â min.'
      ];
      const high = [
        'Prenez 2Â min pour gratitude/journal: que soutient cet espaceÂ ?',
        'Partagez lâ€™ambianceÂ : mini-mÃ©ditation guidÃ©e (2Â min) avec les prÃ©sents.',
        'AllÃ©gezÂ : rÃ©duisez les stimuli (sons/Ã©crans) pour intÃ©grer.'
      ];
      if(v<9000) return base.concat(low).slice(0,6);
      if(v>14000) return base.concat(high).slice(0,6);
      return base.slice(0,6);
    }

    function updateGauge(v){
      elReading.textContent = (v/1000).toFixed(2).replace('.',',');
      const st = statusFor(v);
      elStatus.textContent = st.label;
      elStatus.className = 'tag ' + st.cls;

      // angle 0..180 -> rotation aiguille
      const angle = map(clamp(v, 6000, 18000), 6000, 18000, -90, 90);
      elNeedle.style.transform = `rotate(${angle}deg)`;
      elRange.textContent = '6Â 000 â†’ 18Â 000 kBv';

      // sparkline
      const ctx = elSpark.getContext('2d');
      const W = elSpark.width, H = elSpark.height;
      ctx.clearRect(0,0,W,H);
      ctx.globalAlpha = 0.9;
      ctx.lineWidth = 2;
      ctx.beginPath();
      const len = history.length;
      for(let i=0;i<len;i++){
        const p = history[i];
        const x = map(i, 0, Math.max(1,len-1), 6, W-6);
        const y = map(clamp(p.val,6000,18000), 6000, 18000, H-6, 6);
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      }
      ctx.strokeStyle = '#86e1ff';
      ctx.stroke();
      ctx.globalAlpha = 1;
    }

    function renderAdvice(v){
      const adv = advicesFor(v);
      const box = $('#adviceList');
      box.innerHTML = '';
      adv.forEach(a=>{
        const d = document.createElement('div');
        d.className='advice';
        d.textContent=a; box.appendChild(d);
      });
    }

    function addLog(v){
      const name = elName.value || 'Lieu';
      const lat = +elLat.value || 0, lon = +elLon.value || 0;
      const t = new Date();
      const line = document.createElement('div');
      line.className='advice';
      line.textContent = `${t.toLocaleTimeString()} â€“ ${name} (${lat.toFixed(4)}, ${lon.toFixed(4)}) : ${(v/1000).toFixed(2)} kBv`;
      elLog.prepend(line);
      // garder ~120 lignes
      while(elLog.children.length>120) elLog.removeChild(elLog.lastChild);
    }

    function ping(){
      if(!$('#soundToggle').checked) return;
      try{
        const ctx = new (window.AudioContext||window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type='sine';
        o.frequency.value = 660;
        o.connect(g); g.connect(ctx.destination);
        g.gain.value=0.0001; g.gain.exponentialRampToValueAtTime(0.05, ctx.currentTime+0.02);
        o.start();
        o.stop(ctx.currentTime+0.14);
        setTimeout(()=>ctx.close(), 250);
      }catch(e){}
    }

    function tryWakeLock(){
      if('wakeLock' in navigator){
        navigator.wakeLock.request('screen').then(lock=>{
          wakelock = lock; elWakelock.textContent='ğŸ”’ Ã‰cran actifÂ : oui';
          lock.addEventListener('release',()=>{elWakelock.textContent='ğŸ”’ Ã‰cran actifÂ : non';});
        }).catch(()=>{ elWakelock.textContent='ğŸ”’ Ã‰cran actifÂ : non'; });
      }
    }

    function releaseWakeLock(){ try{ wakelock?.release(); }catch(e){} wakelock=null; elWakelock.textContent='ğŸ”’ Ã‰cran actifÂ : non'; }

    // Boucle
    let rafId = null, tickId = null;
    function start(){
      if(running) return;
      running = true; $('#btnStart').disabled=true; $('#btnStop').disabled=false;
      elSession.textContent='â–¶ï¸ En cours';
      tryWakeLock();
      persist();

      const step = ()=>{
        const now = performance.now();
        const val = computeBovis(now);
        // journal toutes les 6 s et sparkline Ã  ~2 Hz
        if(history.length===0 || now - history.at(-1).t > 500){
          history.push({t:now, val}); if(history.length>300) history.shift();
          updateGauge(val);
        }
        rafId = requestAnimationFrame(step);
      };
      step();
      tickId = setInterval(()=>{
        const v = lastVal;
        addLog(v);
        renderAdvice(v);
        // si variation > seuil, carillon
        if(history.length>3){
          const diff = Math.abs(history.at(-1).val - history.at(-3).val);
          if(diff > (elSens.value==='high'? 1200 : elSens.value==='low'? 400 : 800)) ping();
        }
      }, 6000);
    }

    function stop(){
      running = false; $('#btnStart').disabled=false; $('#btnStop').disabled=true;
      elSession.textContent='â¸ï¸ En pause';
      cancelAnimationFrame(rafId); clearInterval(tickId); releaseWakeLock();
    }

    // ====== Actions UI ======
    $('#btnLocate').addEventListener('click',()=>{
      if(!('geolocation' in navigator)) { alert('GÃ©olocalisation non disponible sur cet appareil.'); return; }
      navigator.geolocation.getCurrentPosition(pos=>{
        const {latitude, longitude} = pos.coords;
        elLat.value = latitude.toFixed(6);
        elLon.value = longitude.toFixed(6);
        persist();
      }, err=>{
        alert('Impossible de rÃ©cupÃ©rer la position ('+err.message+').');
      }, {enableHighAccuracy:true, timeout:8000, maximumAge:10000});
    });

    $('#btnStart').addEventListener('click', start);
    $('#btnStop').addEventListener('click', stop);

    window.addEventListener('keydown', (e)=>{ if(e.key.toLowerCase()==='s'){ running?stop():start(); }});

    [elLat, elLon, elName, elRadius, elBaseline, elSens].forEach(el=> el.addEventListener('change',()=>{ persist(); if(!running){ lastVal = +elBaseline.value||9000; updateGauge(lastVal); renderAdvice(lastVal);} }));

    // Export CSV
    $('#btnExport').addEventListener('click',()=>{
      if(history.length===0){ alert('Pas encore de donnÃ©es Ã  exporter.'); return; }
      const head = 'timestamp_ms;heure;latitude;longitude;nom;rayon_m;kBv\n';
      const rows = history.map(h=>{
        const t = new Date();
        const lat = +elLat.value||0, lon = +elLon.value||0; const name = (elName.value||'Lieu').replace(/;/g, ',');
        return [Math.floor(h.t), new Date(Date.now()).toLocaleTimeString(), lat.toFixed(6), lon.toFixed(6), name, (+elRadius.value||0), (h.val/1000).toFixed(2)].join(';');
      }).join('\n');
      const blob = new Blob([head+rows], {type:'text/csv;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='bovis_session.csv'; a.click();
      URL.revokeObjectURL(url);
    });

    // Initial render
    updateGauge(+elBaseline.value||9000);
    renderAdvice(+elBaseline.value||9000);
  </script>
</body>
</html>
